#!/bin/sh

# configure script for FlexibleSUSY
# Author: Alexander Voigt

# directory of this script
BASEDIR=$(dirname $0)

# absolute path to this script
ABSBASEDIR=$(cd $BASEDIR; pwd)

# operating system
operating_system="`(uname -s) 2>/dev/null || echo unknown`"

# determine Mathematica user directory
case "$operating_system" in
    Darwin)     mathematica_dir="${HOME}/Library/Mathematica" ;;
    CYGWIN_NT*) mathematica_dir="${USERPROFILE}/AppData/Roaming/Mathematica" ;;
    # Linux, *BSD
    *)          mathematica_dir="${HOME}/.Mathematica" ;;
esac

mathematica_applications_dir="${mathematica_dir}/Applications"
sarah_default_dir="${mathematica_applications_dir}/SARAH"
flexiblesusy_sarah_dir="${BASEDIR}/sarah"
mathematica_kernel="math"

overwrite="no"
model_file=""
name=""
sarah_model=""

# exit codes
exit_ok="0"
exit_syntax_error="1"
exit_model_dir_exists="2"
exit_no_default_model="3"

createmodel_log="createmodel.log"

#_____________________________________________________________________
find_default_model_files() {
    # searches for FlexibleSUSY.m.in files within the model_files/
    # directory.  If a FlexibleSUSY.m.in was found, the corresponding
    # model name will be stored in the variable $default_models .

    default_models="`find ${BASEDIR}/model_files/ -mindepth 2 -type f -name FlexibleSUSY.m.in -printf '%h\n' | awk -F / '{ print $NF }' | tr '\n' ' ' | sort -u`"
}

#_____________________________________________________________________
help() {
    find_default_model_files
    local available_default_model_files="${default_models}"

cat <<EOF
Usage: ./`basename $0` [options] --name=<model-name>
Options:
  --name=            Name of the FlexibleSUSY model.
                     Example: --name=MyMSSM

  --model-file=      Name of the model whose FlexibleSUSY model file
                     should be used.  If empty, it will be searched for
                     model_files/<model-name>/FlexibleSUSY.m.in , where
                     <model-name> is the name of the FlexibleSUSY model
                     given by --name= .  All FlexibleSUSY model files
                     are stored in model_files/ .
                     Available models are: ${available_default_model_files}

  --sarah-model=     Name of the SARAH model, used in SARAH\`Start[].
                     If empty, the value given by --name= is used.
                     A sub-model can be specified after a /
                     Syntax: <sarah-model>[/<sub-model>]
                     Example: --sarah-model=MSSM/CKM

  --with-math-cmd=   Mathematica kernel (default: ${mathematica_kernel})
                     Example: --with-math-cmd=${mathematica_kernel}

  --force,-f         Overwrite existing model files.

  --help,-h          Print this help message.

Examples:

  Create a FlexibleSUSY model for the E6SSM:

    ./createmodel --name=E6SSM

  Create a new FlexibleSUSY model named MyMSSM, using the FlexibleSUSY
  model file model_files/NUHMSSM/FlexibleSUSY.m.in and using the MSSM
  as underlying SARAH model (SARAH\`Start["MSSM"]).

    ./createmodel --name=MyMSSM --model-file=NUHMSSM --sarah-model=MSSM
EOF
}

#_____________________________________________________________________
exists_in_path () {
    # This function will try to locate an executable [$1] in $PATH.
    #
    # The result of the search is stored in cmd, which should be
    # immediately copied, since the variables value will be
    # overwritten at next invocation of this function.

    # Assert that we got enough arguments
    if test $# -ne 1 ; then
        echo "exists_in_path: Exactly one argument required"
        return 1
    fi

    cmd=$(command -v -- "$1")
    case "$cmd" in
	/*) return 0 ;;
	alias\ *) return 1 ;; # alias
	*) return 1 ;; # built-in or function
    esac
}

# contains(string, substring)
#
# Returns 0 if the specified string contains the specified substring,
# otherwise returns 1.
contains() {
    string="$1"
    substring="$2"
    if test "${string#*$substring}" != "$string"
    then
        return 0    # $substring is in $string
    else
        return 1    # $substring is not in $string
    fi
}

check_model_name() {
    if test $# -ne 1 ; then
        echo "check_model_name: Exactly one argument required"
        exit 1
    fi

    local _model="$1"

    [ $(echo "${_model}" | grep -E "^[a-zA-Z][0-9a-zA-Z_]*$") ] || \
        { printf "Error: invalid model name: ${_model}\n" && exit 1; }
}

check_sarah_model() {
    if test $# -ne 2 ; then
        echo "check_sarah_model: Exactly one argument required"
        exit 1
    fi

    local _sarah_model="$1"
    local _sub_model="$2"

    if [ -n "${_sub_model}" ]; then
        _sarah_model="${_sarah_model}/${_sub_model}"
    fi

    local found="no"

    printf "Checking SARAH model ${_sarah_model} ... "

    if ! exists_in_path "$mathematica_kernel"; then
        printf "error\n"
        echo "Error: could not find Mathematica kernel \"${mathematica_kernel}\""
        echo "    Please specify the Mathematica kernel via --with-math-cmd="
        exit 1
    fi

    # checking SARAH installation
    "$mathematica_kernel" <<EOF > /dev/null
Needs["SARAH\`"];
If[!ValueQ[SA\`Version], Quit[1]];
Quit[0];
EOF
    local _sarah_is_available="$?"
    if test ! "x${_sarah_is_available}" = "x0" ; then
        printf "error\n"
        echo "Error: SARAH could not be loaded via Needs[\"SARAH\`\"] ."
        echo "    Please install SARAH such that it can be loaded via Needs[\"SARAH\`\"] ."
        echo "    You can use ./install-sarah to install SARAH."
        exit 1
    fi

    # trying to load model file
    "${mathematica_kernel}" <<EOF 1> /dev/null 2> ${createmodel_log}
FindModelFiles[dir_String, modelName_String, submodeldir_] :=
    Module[{files, modelFile, modelDir},
           If[submodeldir =!= False,
              modelDir  = FileNameJoin[{dir, modelName, submodeldir}];
              modelFile = FileNameJoin[{modelDir, modelName <> "-" <> submodeldir <> ".m"}];
              ,
              modelDir  = FileNameJoin[{dir, modelName}];
              modelFile = FileNameJoin[{modelDir, modelName <> ".m"}];
             ];
           files = Join[{modelFile},
                        FileNameJoin[{modelDir, #}]& /@ {"parameters.m", "particles.m"}
                       ];
           Select[files, FileExistsQ]
          ];

sarahLoaded = Needs["SARAH\`"];

If[sarahLoaded === \$Failed || !ValueQ[\$sarahModelDir],
   Quit[1];
  ];

If[!StringFreeQ["${_sarah_model}","/"],
   splitted = StringSplit["${_sarah_model}","/"];
   modelName = splitted[[1]];
   submodeldir = splitted[[2]];
   ,
   modelName = "${_sarah_model}";
   submodeldir = False;
];

(* search in SARAH/Models/ directory *)
files = FindModelFiles[\$sarahModelDir, modelName, submodeldir];

(* search in FlexibleSUSY/sarah/ directory *)
If[files === {},
   files = FindModelFiles["${flexiblesusy_sarah_dir}", modelName, submodeldir];
  ];

If[files === {},
   WriteString["stderr", "    " <> \$sarahModelDir <> "\n    ${flexiblesusy_sarah_dir}" <> "\n"];
   Quit[1];
   ,
   Quit[0]
  ];
EOF
    local _model_is_available="$?"
    if test "x${_model_is_available}" = "x0" ; then
        found="ok"
    fi

    if test "${found}" = "ok" ; then
        printf "ok\n"
        return 0
    else
        printf "not found\n"
        echo "Error: SARAH model ${_sarah_model} not found in"
        cat ${createmodel_log}
        exit 1
    fi
}

if test $# -lt 1 ; then
    echo "Error: Too few arguments"
    help
    exit ${exit_syntax_error}
fi

rm -f ${createmodel_log}

if test $# -gt 0 ; then
    while test ! "x$1" = "x" ; do
        case "$1" in
            -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
            *)    optarg= ;;
        esac

        case $1 in
            --force|-f)              overwrite="yes" ;;
            --help|-h)               help; exit ${exit_ok} ;;
            --model-file=*)          model_file="$optarg" ;;
            --name=*)                name="$optarg" ;;
            --sarah-model=*)         sarah_model="$optarg" ;;
            --with-math-cmd=*)       mathematica_kernel="$optarg" ;;
            *)  echo "Invalid option '$1'. Try $0 --help" ; exit ${exit_syntax_error} ;;
        esac
        shift
    done
fi

if [ -z "$name" ] ; then
    echo "Error: no model specified!"
    help
    exit ${exit_syntax_error}
fi

sub_model=$(echo $sarah_model | awk -F / '{ if (NF > 1) print $NF }')
sarah_model=$(echo $sarah_model | awk -F / '{ print $1 }')

if [ -z "$sarah_model" ]; then
    sarah_model="$name"
fi

check_model_name "${name}"
check_sarah_model "${sarah_model}" "${sub_model}"

# create target directory name
targetdir="models/${name}"

if test -d "$targetdir" -a "x$overwrite" = "xno" ; then
    echo "Error: directory $targetdir already exists!"
    echo "Please chose another model name or use the --force option."
    echo "See ./`basename $0` --help for more information."
    exit ${exit_model_dir_exists}
fi

if [ -n "$sub_model" ]; then
    echo "Creating model $name (SARAH model: $sarah_model, sub-model: $sub_model)"
else
    echo "Creating model $name (SARAH model: $sarah_model)"
fi

# check if we provide a FlexibleSUSY model file for the given model
# name
model_file_dir="model_files"
if [ -n "$model_file" ]; then
    printf "  searching for ${model_file} model file ... "
    if test -d "$model_file_dir/$model_file"; then
        model_file_dir="$model_file_dir/$model_file"
        printf "found in ${model_file_dir}/\n"
    else
        printf "not found in ${model_file_dir}/${model_file}\n"
        echo "Error: There is no model file for the ${model_file}!"
        echo "  You can create one via"
        echo ""
        echo "  \$ mkdir ${model_file_dir}/${model_file}"
        echo "  \$ cp ${model_file_dir}/MSSM/FlexibleSUSY.m.in ${model_file_dir}/${model_file}/"
        exit ${exit_no_default_model}
    fi
else
    # if the user has no default model file specified, we check if one
    # exists in model_files/$name/
    if test -r "$model_file_dir/$name/FlexibleSUSY.m.in"; then
        model_file_dir="$model_file_dir/$name"
        printf "  Using model file ${model_file_dir}/FlexibleSUSY.m.in\n"
    else
        echo "Error: No FlexibleSUSY model file found in ${model_file_dir}/${name}/"
        echo "  You can either create a model file via"
        echo ""
        echo "  \$ mkdir ${model_file_dir}/${name}"
        echo "  \$ cp ${model_file_dir}/MSSM/FlexibleSUSY.m.in ${model_file_dir}/${name}/"
        echo ""
        echo "  or you can specify the model file via"
        echo ""
        echo "  \$ ./`basename $0` [...] --model-file=MSSM"
        exit ${exit_no_default_model}
    fi
fi

if test ! -d "$targetdir" ; then
    printf "  Creating model directory %s ... " "$targetdir"
    mkdir $targetdir
    echo "done"
fi

set -- $(find $model_file_dir -type f -iname LesHouches.in\* -printf " %f")
SLHA_input_files="$*"

SLHA_input_files_in_mk=$(echo "$SLHA_input_files" |
    sed 's/ / \\\\\\n/g;
	 s,\(^\|\\n\)\(.\),\1		$(DIR)/\2,g')

printf "  Creating Makefile module %s/module.mk ... " "$targetdir"
sed -e "s|@DIR@|$targetdir|g"			  \
    -e "s|@MODEL@|$sarah_model|g"		  \
    -e "s|@CLASSNAME@|$name|g"			  \
    -e "s|@SLHA_INPUT@|$SLHA_input_files_in_mk|g" \
    < templates/module.mk.in > $targetdir/module.mk
echo "done"

printf "  Creating start script %s/start.m ... " "$targetdir"
sub_model_replacement=""
if [ -n "$sub_model" ]; then
    sub_model_replacement=", \"$sub_model\""
fi
sed -e "s|@DIR@|$targetdir|g"                     \
    -e "s|@ModelName@|$sarah_model|g"             \
    -e "s|@SubModel@|$sub_model_replacement|g"    \
    -e "s|@CLASSNAME@|$name|g"                    \
    < templates/start.m.in > $targetdir/start.m
echo "done"

printf "  Creating FlexibleSUSY model file %s/FlexibleSUSY.m ... " "$targetdir"
sed -e "s|@DIR@|$targetdir|g"               \
    -e "s|@ModelName@|$sarah_model|g"       \
    -e "s|@CLASSNAME@|$name|g"              \
    < $model_file_dir/FlexibleSUSY.m.in > $targetdir/FlexibleSUSY.m
echo "done"

for slha_in in $SLHA_input_files; do
    printf "  Creating SLHA input file %s/%s ... " "$targetdir" "$slha_in"
    cp $model_file_dir/$slha_in $targetdir
    echo "done"
done

rm -f ${createmodel_log}
